import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import sys
import os
import argparse

def plot_plateau_results(npz_file_path):
    # --- File Handling ---
    results_dir = 'results'
    output_filename_prefix = os.path.splitext(os.path.basename(npz_file_path))[0]

    # Load Data
    print(f"Loading data from: {npz_file_path}")
    data = np.load(npz_file_path)

    X_np = data['X']
    Y_np = data['Y']
    u_true_stage1 = data['u_true_stage1']
    v_true_stage1 = data['v_true_stage1']
    true_nu_stage1 = data['true_nu_stage1']
    nu_values_for_plotting = data['nu_values_for_plotting']

    # --- Visualization ---
    # Plotting u-velocity
    fig_u = plt.figure(figsize=(20, 10), dpi=120)
    fig_u.suptitle(f"U-Velocity Comparison (True nu_stage1 = {true_nu_stage1:.4f})")

    # True u-velocity
    ax_u_true = fig_u.add_subplot(2, len(nu_values_for_plotting), 1, projection='3d')
    ax_u_true.set_title("True U-Velocity")
    surf_u_true = ax_u_true.plot_surface(X_np, Y_np, u_true_stage1, cmap=cm.viridis, antialiased=True)
    fig_u.colorbar(surf_u_true, ax=ax_u_true, shrink=0.5, aspect=10)
    ax_u_true.set_xlabel('X')
    ax_u_true.set_ylabel('Y')
    ax_u_true.set_zlabel('u')

    # Predicted u-velocity for each nu
    for i, nu_val in enumerate(nu_values_for_plotting):
        u_pred_key = f'u_pred_nu_{nu_val}'
        u_pred = data[u_pred_key]
        mse_u = np.mean((u_true_stage1 - u_pred)**2)

        ax_u_pred = fig_u.add_subplot(2, len(nu_values_for_plotting), i + 2, projection='3d')
        ax_u_pred.set_title(f"Predicted U-Velocity (nu = {nu_val:.2f})\nMSE = {mse_u:.2e}")
        surf_u_pred = ax_u_pred.plot_surface(X_np, Y_np, u_pred, cmap=cm.viridis, antialiased=True)
        fig_u.colorbar(surf_u_pred, ax=ax_u_pred, shrink=0.5, aspect=10)
        ax_u_pred.set_xlabel('X')
        ax_u_pred.set_ylabel('Y')
        ax_u_pred.set_zlabel('u')

    plt.tight_layout()
    output_path_u = os.path.join(results_dir, f'{output_filename_prefix}_u_velocity.jpg')
    plt.savefig(output_path_u)
    print(f"U-velocity plot saved to: {output_path_u}")

    # Plotting v-velocity
    fig_v = plt.figure(figsize=(20, 10), dpi=120)
    fig_v.suptitle(f"V-Velocity Comparison (True nu_stage1 = {true_nu_stage1:.4f})")

    # True v-velocity
    ax_v_true = fig_v.add_subplot(2, len(nu_values_for_plotting), 1, projection='3d')
    ax_v_true.set_title("True V-Velocity")
    surf_v_true = ax_v_true.plot_surface(X_np, Y_np, v_true_stage1, cmap=cm.viridis, antialiased=True)
    fig_v.colorbar(surf_v_true, ax=ax_v_true, shrink=0.5, aspect=10)
    ax_v_true.set_xlabel('X')
    ax_v_true.set_ylabel('Y')
    ax_v_true.set_zlabel('v')

    # Predicted v-velocity for each nu
    for i, nu_val in enumerate(nu_values_for_plotting):
        v_pred_key = f'v_pred_nu_{nu_val}'
        v_pred = data[v_pred_key]
        mse_v = np.mean((v_true_stage1 - v_pred)**2)

        ax_v_pred = fig_v.add_subplot(2, len(nu_values_for_plotting), i + 2, projection='3d')
        ax_v_pred.set_title(f"Predicted V-Velocity (nu = {nu_val:.2f})\nMSE = {mse_v:.2e}")
        surf_v_pred = ax_v_pred.plot_surface(X_np, Y_np, v_pred, cmap=cm.viridis, antialiased=True)
        fig_v.colorbar(surf_v_pred, ax=ax_v_pred, shrink=0.5, aspect=10)
        ax_v_pred.set_xlabel('X')
        ax_v_pred.set_ylabel('Y')
        ax_v_pred.set_zlabel('v')

    plt.tight_layout()
    output_path_v = os.path.join(results_dir, f'{output_filename_prefix}_v_velocity.jpg')
    plt.savefig(output_path_v)
    print(f"V-velocity plot saved to: {output_path_v}")

    data.close()

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Plot results from main_plateau.py NPZ file.')
    parser.add_argument('npz_file_path', type=str, help='The path to the NPZ file generated by main_plateau.py.')
    args = parser.parse_args()
    
    plot_plateau_results(args.npz_file_path)
